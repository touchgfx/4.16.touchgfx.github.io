<!doctype html>
<html lang="zh-TW" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-development/touchgfx-hal-development/touchgfx-architecture">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="search" type="application/opensearchdescription+xml" title="TouchGFX Documentation" href="/4.16/zh-TW/opensearch.xml">
<script src="/4.16/js/fix-location.js"></script><title data-rh="true">抽象層架構 | TouchGFX Documentation</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://support.touchgfx.com/4.16/zh-TW/img/meta-image.png"><meta data-rh="true" name="twitter:image" content="https://support.touchgfx.com/4.16/zh-TW/img/meta-image.png"><meta data-rh="true" property="og:url" content="https://support.touchgfx.com/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-architecture"><meta data-rh="true" name="docusaurus_locale" content="zh-TW"><meta data-rh="true" name="docsearch:language" content="zh-TW"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="抽象層架構 | TouchGFX Documentation"><meta data-rh="true" name="description" content="如前一節所述，TouchGFX AL具有一套特定的職責。 這套職責一般是透過RTOS （OSAL）來實現，可以在AL （HAL）的硬體部分實現，也可在與TouchGFX引擎同步的AL部分實現。 下表總結了這些在前一節中概述的職責："><meta data-rh="true" property="og:description" content="如前一節所述，TouchGFX AL具有一套特定的職責。 這套職責一般是透過RTOS （OSAL）來實現，可以在AL （HAL）的硬體部分實現，也可在與TouchGFX引擎同步的AL部分實現。 下表總結了這些在前一節中概述的職責："><link data-rh="true" rel="icon" href="/4.16/zh-TW/img/favicon.png"><link data-rh="true" rel="canonical" href="https://support.touchgfx.com/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-architecture"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.16/docs/development/touchgfx-hal-development/touchgfx-architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.16/ko/docs/development/touchgfx-hal-development/touchgfx-architecture" hreflang="ko"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.16/ja/docs/development/touchgfx-hal-development/touchgfx-architecture" hreflang="ja"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.16/zh-CN/docs/development/touchgfx-hal-development/touchgfx-architecture" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-architecture" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.16/docs/development/touchgfx-hal-development/touchgfx-architecture" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://B8LNOI0XWD-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/4.16/zh-TW/assets/css/styles.ec0ff9ef.css">
<link rel="preload" href="/4.16/zh-TW/assets/js/runtime~main.eee51835.js" as="script">
<link rel="preload" href="/4.16/zh-TW/assets/js/main.3ffa3542.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/4.16/zh-TW/docs/introduction/welcome"><div class="navbar__logo"><img src="/4.16/zh-TW/img/logo.svg" alt="TouchGFX" class="themedImage_ToTc themedImage--light_HNdA"><img src="/4.16/zh-TW/img/logo.svg" alt="TouchGFX" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">繁體中文</a><ul class="dropdown__menu"><li><a href="/4.16/docs/development/touchgfx-hal-development/touchgfx-architecture" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/4.16/ko/docs/development/touchgfx-hal-development/touchgfx-architecture" target="_self" rel="noopener noreferrer" class="dropdown__link">한국어</a></li><li><a href="/4.16/ja/docs/development/touchgfx-hal-development/touchgfx-architecture" target="_self" rel="noopener noreferrer" class="dropdown__link">日本語</a></li><li><a href="/4.16/zh-CN/docs/development/touchgfx-hal-development/touchgfx-architecture" target="_self" rel="noopener noreferrer" class="dropdown__link">简体中文</a></li><li><a href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-architecture" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">繁體中文</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/4.16/zh-TW/docs/introduction/welcome">4.16</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-architecture">4.16</a></li><li><a href="https://support.touchgfx.com/4.15" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.15<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.14" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.14<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.13" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.13<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://community.st.com/s/topic/0TO0X0000003iw6WAA/touchgfx" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community</a><a href="https://touchgfx.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">TouchGFX.com</a><div class="searchBox_ZlJk"><div class="searchBox_Gz_y"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/4.16/zh-TW/docs/introduction/welcome">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/4.16/zh-TW/docs/basic-concepts/embedded-graphics">Basic Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/4.16/zh-TW/docs/development/development-introduction">Development</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.16/zh-TW/docs/development/development-introduction">開發簡介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/4.16/zh-TW/docs/development/hardware-selection/hardware-selection-introduction">Hardware Selection</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/4.16/zh-TW/docs/development/board-bring-up/board-introduction">Board Bring Up</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-al-development-introduction">TouchGFX AL Development</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-al-development-introduction">TouchGFX AL 開發簡介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-architecture">抽象層架構</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-generator">Generator使用者指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/4.16/zh-TW/docs/development/touchgfx-hal-development/scenarios/scenarios-ltdc-parallel-rgb">Scenarios</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/4.16/zh-TW/docs/development/ui-development/ui-development-introduction">UI Development</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/4.16/zh-TW/docs/development/scenarios/touchgfx-on-lowcost-hardware">Scenarios</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/4.16/zh-TW/docs/miscellaneous/updating-to-a-new-touchgfx-version">Miscellaneous</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/4.16/zh-TW/docs/tutorials/tutorial-01">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/4.16/zh-TW/docs/api/classes/classtouchgfx_1_1_abstract_button">API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/4.16/zh-TW/docs/resources/presentations">Resources</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><span class="breadcrumbs__link">Development</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">TouchGFX AL Development</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">抽象層架構</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>抽象層架構</h1></header><p>如前一節所述，TouchGFX AL具有一套特定的職責。 這套職責一般是透過RTOS （OSAL）來實現，可以在AL （HAL）的硬體部分實現，也可在與TouchGFX引擎同步的AL部分實現。 下表總結了這些在前一節中概述的職責：</p><table><thead><tr><th>職責（Responsibility）</th><th>作業系統或硬體</th></tr></thead><tbody><tr><td><a href="#synchronize-touchgfx-engine-main-loop-with-display-transfer">將TouchGFX引擎主迴圈與顯示器的傳輸作同步</a></td><td>作業系統與硬體</td></tr><tr><td><a href="#report-touch-and-physical-button-events">回報觸摸銀幕與實體按鈕事件</a></td><td>硬體</td></tr><tr><td><a href="#synchronize-framebuffer-access">同步影像緩衝區的存取</a></td><td>作業系統</td></tr><tr><td><a href="#report-the-next-available-framebuffer-area">回報下一個可用的影像緩衝區</a></td><td>硬體</td></tr><tr><td><a href="#perform-render-operations">執行渲染算圖操作</a></td><td>硬體</td></tr><tr><td><a href="#handle-framebuffer-transfer-to-display">影像緩衝區到影示器的傳輸處理 </a></td><td>硬體</td></tr></tbody></table><p>以下每個小節對為實現上述職責應所採取的措施作重點介紹。 對於客製化的硬體平台，STM32CubeMX中的TouchGFX Generator可以產生大多數的AL程式碼和與其對應的TouchGFX專案。 其餘部分就必須由AL的開發人員依據程式碼的註釋或者是依據TouchGFX Generator的通知指示來自行手動實作。 在下一節中<a href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-generator">閱讀更多</a>有關TouchGFX Generator的資訊。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="abstraction-layer-classes">抽象層物件類別<a class="hash-link" href="#abstraction-layer-classes" title="Direct link to heading">​</a></h3><p>TouchGFX引擎透過<code>HAL</code>的具體物件子類別來存取HAL。 這些物件子類別由TouchGFX Generator產生。  作為產生抽象層程式碼的主要工具，TouchGFX Generator可同時產生反映CubeMX設定的HAL程式碼和CMSIS V1和V2的OSAL程式碼。 請閱讀<a href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-generator">TouchGFX Generator</a>章節，以取得更多詳細資訊。 通常，HAL的架構如下圖所示。</p><div class="figure noshadow"><a href="/4.16/zh-TW/img/development/touchgfx-hal-development/code-architecture.webp" target="_blank"><img width="200" src="/4.16/zh-TW/img/development/touchgfx-hal-development/code-architecture.webp"></a><p>產生的程式碼之階層結構</p></div><p></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="synchronize-touchgfx-engine-main-loop-with-display-transfer">將「TouchGFX引擎主迴圈」與「顯示傳輸」同步<a class="hash-link" href="#synchronize-touchgfx-engine-main-loop-with-display-transfer" title="Direct link to heading">​</a></h2><p>這一步驟背後的主要想法是在渲染算圖完成之後阻塞擱置TouchGFX引擎主迴圈以確保不再產生其他圖框（frame）。 一旦顯示準備就緒，OSAL向被阻塞擱置的引擎主迴圈發出信號以繼續產生顯示圖框（frame）。</p><p>為實現該職責，TouchGFX AL的典型方法就如同前一節中所述，是利用<em>渲染算圖完成</em>的引擎掛鉤以及<em>顯示就緒</em>的中斷來達成。 OSAL定義了<code>OSWrappers::signalVSync</code>函式，開發人員可透過它發送旗號（semaphore）給先前已呼叫<code>OSWrappers::signalVSync</code> 而等待此旗號的引擎。</p><div class="highlight highlight-tip"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></div>Tip</h5></div><div class="highlight-content">TouchGFX Generator可以產生基於CMSIS V1和V2的完整OSAL。</div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rendering-done">渲染算圖完成<a class="hash-link" href="#rendering-done" title="Direct link to heading">​</a></h3><p>在渲染算圖完成之後， TouchGFX Engine會呼叫<em>渲染算圖完成</em>的鉤子<code>OSWrappers::waitForVSync</code>。</p><p>在實作此AL物件方法時，AL必須阻塞擱置（block）圖形引擎直至該渲染下一個圖框的時間。 實作該阻塞擱置的標準方法是阻止由訊息佇列（message queue）進行讀取。 如果此方法不可行，則HAL開發人員可自由使用任何方法來實作該阻塞擱置。</p><div class="highlight highlight-tip"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></div>Tip</h5></div><div class="highlight-content">如果沒有RTOS，TouchGFX Generator也可以產生一個使用自旋鎖（spinlock）作等待的空白OSAL而不使用RTOS物件（primitive）。</div></div><p>當<code>OSWrappers::signalVSync</code>發出信號時（或<code>OSWrappers::waitForVSync</code>所用的旗號/佇列發出信號時），TouchGFX即開始渲染下一個應用圖框（application frame）。 以下基於CMSIS V1的程式碼會造成TouchGFX引擎的阻塞擱置（block）直到一個元素被系統中其它部份（通常是與顯示同步的中斷）加進佇列當中。</p><div class="code-header"><div><h5>RTOS_OSWrappers.cpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> osMessageQId vsync_queue </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//Queue identifier is assigned elsewhere</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">OSWrappers</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">waitForVSync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//Wait for next VSYNC to occur, by reading from the queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">osMessageGet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">vsync_queue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> osWaitForever</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果不使用RTOS，TouchGFX Generator為<code>waitForVSync</code>提供了以下使用揮發性易失變數（volatile variable）方式的實作。</p><div class="code-header"><div><h5>NO_OS_OSWrappers.cpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">volatile</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">uint8_t</span><span class="token plain"> vsync_sem </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">OSWrappers</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">waitForVSync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">while</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">vsync_sem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Perform other work while waiting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="highlight highlight-tip"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></div>Tip</h5></div><div class="highlight-content"><li><b><i>在</i></b>TouchGFX 引擎等待產生下一個圖框時，其他任務可以執行重要的工作。</li></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="display-ready">顯示就緒<a class="hash-link" href="#display-ready" title="Direct link to heading">​</a></h3><p>用於解除主迴圈阻塞擱置的<em>顯示就緒</em>信號應該來自顯示控制器的中斷、顯示器本身的中斷或是硬體定時器的中斷。 信號源取決於顯示類型。</p><p><code>OSWrappers</code>物件類別為此信號定義了一個函式：<code>OSWrappers::signalVsync</code>。 該函式的實作必須透過滿足<code>OSWrappers::waitForVSync</code>中所使用的等待條件來解除主迴圈的阻塞擱置。</p><p>接繼上面的CMSIS RTOS範例，以下程式碼將訊息放入訊息佇列<code>vsync_queue</code>中以解除TouchGFX引擎的阻塞擱置。</p><div class="code-header"><div><h5>RTOS_OSWrappers.cpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">OSWrappers</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">signalVSync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">vsync_queue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">osMessagePut</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">vsync_queue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> dummy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這個<code>OSWrappers::signalVSync</code>物件方法必須在硬體層面上透過LTDC中斷，顯示器的外部中斷或硬體計時器中斷來呼叫。</p><p>如果不使用RTOS，則使用變數，並分配一個非零值以打破while循環。</p><div class="code-header"><div><h5>NO_OS_OSWrappers.cpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">OSWrappers</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">signalVSync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    vsync_sem </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="report-touch-and-physical-button-events">回報銀幕觸摸和實體按鈕事件<a class="hash-link" href="#report-touch-and-physical-button-events" title="Direct link to heading">​</a></h2><p>在渲染計算（render）新的畫面圖框（frame）之前，TouchGFX引擎從<code>TouchController</code>和<code>ButtonController</code>介面收集外部輸入。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="touch-coordinates">銀幕觸控座標<a class="hash-link" href="#touch-coordinates" title="Direct link to heading">​</a></h3><p>引擎將觸控控制器的座標轉換為「點按（click）」、「拖曳（drag）」和「手勢（gesture）」事件，並將其傳遞至應用程式。 以下程式碼由TouchGFX Generator產生：</p><div class="code-header"><div><h5>TouchGFXConfiguration.cpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line theme-code-block-highlighted-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> STM32TouchController tc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> STM32L4DMA dma</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> LCD24bpp display</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> ApplicationFontProvider fontProvider</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> Texts texts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> TouchGFXHAL </span><span class="token function" style="color:rgb(130, 170, 255)">hal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">dma</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> display</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> tc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">390</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">390</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在TouchGFX Engine渲染算圖（render）的過程中，引擎呼叫<em>tc</em>物件的<code>sampleTouch()</code>函式來收集輸入。</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">STM32TouchController</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">sampleTouch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int32_t</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int32_t</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>AL開發人員提供的實作應該讀取銀幕觸控座標的x和y值，並回傳是否偵測到銀幕觸控（真或偽）。</p><div class="highlight highlight-tip"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></div>Tip</h5></div><div class="highlight-content">TouchGFX Generator將產生一個物件類別，此物件類別將TouchController介面定義為空函式。 HAL開發人員必須在此空函式中填入具體的實作程式碼。</div></div><p>有多種實作此函式的方法：</p><ol><li><strong><em>在sampleTouch() 中輪詢（polling）</em></strong>：透過發送請求並等待輪詢結果，可從硬體觸控控制器（通常為I2C）讀取螢幕觸摸狀態。 這會影響應用程式的總體渲染算圖時間，因為i2C的往返傳輸通常長達1ms，在此期間圖形引擎會被阻塞擱置（blocked）。</li><li><strong><em>使用中斷</em></strong>：另一種可能是使用中斷。 I2C讀取的命令由定時器定期啟動，或者以回應觸控硬體控制器的外部中斷來啟動。 當I2C資料就緒時（可視為另一個中斷），此資料可透過訊息佇列（message queue）或全域變數將資料提供給<code>STM32TouchController</code>。 以下展示了由TouchGFX Generator所產生的<code>STM32TouchController.cpp</code>程式碼<code>sampleTouch</code>在RTOS系統中的可能樣貌：</li></ol><div class="code-header"><div><h5>STM32TouchController.cpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">STM32TouchController</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">sampleTouch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int32_t</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int32_t</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">osMessageQueueGet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">mid_MsgQueue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(130, 170, 255)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> osOK</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        x </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        y </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此檔案的位置將在下一章的TouchGFX Generator中說明</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="other-external-events">其他的外部事件<a class="hash-link" href="#other-external-events" title="Direct link to heading">​</a></h3><p>按鈕控制器介面<code>touchgfx::ButtonController</code>可用於將硬體訊號（按鈕或其他）映射到應用程式事件。 可在TouchGFX Designer中設定對這些事件的反應方式。</p><p>該介面的使用與上述觸控控制器類似，只是並不一定要具有ButtonController。 要使用此介面，請建立一個具有<code>ButtonController</code>介面實作的實體物件，並將指向此實體物件的參照（reference）傳遞至HAL</p><div class="code-header"><div><h5>MyButtonController.cpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">MyButtonController</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="font-style:italic">public</span><span class="token base-clause"> touchgfx</span><span class="token base-clause double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token base-clause class-name" style="color:rgb(255, 203, 107)">ButtonController</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sample</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">uint8_t</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//Sample IO, set key, return true/false</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="code-header"><div><h5>TouchGFXConfiguration.cpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> MyButtonController bc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">touchgfx_init</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">initialize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">setButtonController</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">bc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在每個圖框之前都會呼叫上述ButtonController物件類別當中的<em>樣本</em>方法。 當回傳真值時，鍵值（key value）將被傳遞至目前螢幕（screen）的<em>handleKeyEvent</em>事件處理程式。</p><div class="highlight highlight-further-reading"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></div>Further reading</h5></div><div class="highlight-content">關於如何以ButtonController取樣而得到的數值作為設計工具中互動行為的觸發源，請參見<a href="/4.16/zh-TW/docs/development/ui-development/designer-user-guide/interactions-view">互動</a>文章。</div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="synchronize-framebuffer-access">影像緩衝存取的同步<a class="hash-link" href="#synchronize-framebuffer-access" title="Direct link to heading">​</a></h2><p>多個執行單元（actors）可能都會對影像緩衝區進行存取。</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>1</td><td>CPU</td><td>在渲染算圖期間讀取和寫入像素</td></tr><tr><td>2</td><td>DMA2D<strong>*</strong></td><td>在硬體輔助的渲染算圖期間讀取和寫入像素</td></tr><tr><td>3</td><td>LTDC</td><td>在傳輸到並列RGB顯示器期間讀取像素</td></tr><tr><td>4</td><td>DMA</td><td>在傳輸到SPI顯示器期間讀取像素</td></tr></tbody></table><p>TouchGFX引擎透過<code>OSWrappers</code>介面來同步影像緩衝區的存取，而對於同時也希望存取影像緩衝區的週邊（如DMA2D）也必須執行相同操作（透過OSWrapper對影像緩衝區進行存取）。 常見的設計是使用旗號（semaphore）來確保（guard）對影像緩衝區的存取，但也可以使用其它的同步機制。</p><p>下表顯示了<code>OSWrappers</code>物件類別（OSWrappers.cpp）中的函式列表，包含了由TouchGFX Generator產生的函式或由使用者手動生成的函式。</p><table><thead><tr><th>物件方法</th><th>說明</th></tr></thead><tbody><tr><td><code>takeFrameBufferSemaphore</code></td><td>由圖形引擎呼叫以獲取對影像緩衝區的獨佔存取。 這將阻塞擱置引擎直到DMA2D完成（若正在執行的話）</td></tr><tr><td><code>tryTakeFrameBufferSemaphore</code></td><td>確保已取得旗號鎖定（lock）。 此方法不會阻塞擱置，但下一次呼叫takeFrameBufferSemaphore時會阻塞擱置呼叫者</td></tr><tr><td><code>giveFrameBufferSemaphore</code></td><td>釋放影像緩衝區的旗號鎖定（lock）</td></tr><tr><td><code>giveFrameBufferSemaphoreFromISR</code></td><td>在中斷程式當中釋放影像緩衝區的旗號鎖定（lock）</td></tr></tbody></table><div class="highlight highlight-tip"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></div>Tip</h5></div><div class="highlight-content">TouchGFX Generator可產生使用OSWrappers介面來作同步的ChromART驅動程式，以及產生與所選的RTOS對應之同步功能的函式實作。</div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="report-the-next-available-framebuffer-area">回報下一個可用的影像緩衝區<a class="hash-link" href="#report-the-next-available-framebuffer-area" title="Direct link to heading">​</a></h2><p>無論採用哪種渲染算圖的策略，TouchGFX引擎在每個時標（tick）都必須知道應將像素渲染到哪個記憶體區域。 使用單一影像緩衝或雙影像緩衝策略時，TouchGFX引擎將根據影像緩衝區的寬度、高度和位元深度（bit depth）將像素資料寫入記憶體區域。 圖形引擎負責雙影像緩衝區配置當中兩個影像緩衝區之間的交換。</p><p>可以將影像緩衝區的存取局限在部分的影像緩衝區。 可在HAL物件子類別中重新實作<code>HAL::getTFTCurrentLine()</code>物件方法（method）。 回傳上面用於圖形引擎繪製而保存的行號。</p><p>使用局部影像緩衝區策略時，開發人員需定義TouchGFX引擎在渲染算圖時使用的記憶體區塊（一個或多個）。 <a href="/4.16/zh-TW/docs/development/scenarios/lowering-memory-usage-with-partial-framebuffer">由此</a>閱讀更多相關資訊。</p><div class="highlight highlight-tip"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></div>Tip</h5></div><div class="highlight-content">TouchGFX Generator為所有支援的影像緩衝策略提供配置。</div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="perform-render-operations">執行渲染算圖<a class="hash-link" href="#perform-render-operations" title="Direct link to heading">​</a></h2><p>應用程式不是只需要作渲染算圖或是只作圖像顯示。 還有其他工作也需要使用CPU。 TouchGFX的目標之一是盡可能降低CPU資源的使用來繪製使用者介面。 HAL物件類別對許多STM32微控制器（或其他硬體功能）上的DMA2D功能進行抽象化以利圖形引擎的使用。</p><p>將圖資（如點陣圖）渲染演算至影像緩衝區時，TouchGFX引擎檢查HAL是否有能力對局部或者全部的點陣圖進行點陣疊圖（blit）至影像緩衝區。 如果有此功能，則將繪圖操作委託給HAL而不是由CPU直接處理。</p><p>引擎呼叫物件方法<code>HAL::getBlitCaps()</code>以取得硬體能力的描述。 可在HAL物件子類別當中重新實作此呼叫以添加硬體能力的描述。</p><p>引擎在繪製使用者介面時呼叫HAL物件類別上的操作（如<code>HAL::blitCopy</code>）將其排入DMA操作佇列。 如果HAL回報不具備所需的能力，則圖形引擎將退而使用軟體方式來渲染算圖。</p><div class="highlight highlight-tip"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></div>Tip</h5></div><div class="highlight-content"> 許多STM32 MCU具有ChromART，因此在對像素進行Alpha像素混合（Alpha blending）的同時將資料由外部Flash記憶體搬移至影像緩衝區。 對於許多MCU來說，TouchGFX Generator可產生ChromART驅動程式以使用ChromART來增加多個點陣疊圖（blit）操作。 </div></div><p></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="handle-framebuffer-transfer-to-display">從影像緩衝區到顯示器的傳輸處理<a class="hash-link" href="#handle-framebuffer-transfer-to-display" title="Direct link to heading">​</a></h2><p>為將影像緩衝區的內容傳輸到顯示器，TouchGFX AL經常使用「區域渲染完畢（Rendering of area complete）」的掛鉤。 一旦部分影像緩衝區的渲染算圖完成後，引擎就會向AL發送信號。 AL可選擇如何將此影像緩衝區這部分的內容傳輸到顯示器。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rendering-of-area-complete">區域渲染完畢<a class="hash-link" href="#rendering-of-area-complete" title="Direct link to heading">​</a></h3><p>在程式碼當中的掛鉤（hook）為虛擬函式<code>HAL::flushFrameBuffer(Rect&amp; rect)</code>。</p><p>在帶有LTDC控制器的STM32微控制器上我們不需要在每次渲染算圖之後執行任何用於影像緩衝區傳輸的操作。 在完成LTDC初始化之後，該傳輸將以給定的頻率連續執行，因此我們可以在此物件方法的實作留白不作任何處理。</p><p>但對於其他類型的顯示器（如SPI或8080）來說就需要自行手動來實作影像緩衝區的傳輸。</p><p>這函式讓開發者可以發起該影像緩衝區域向顯示器GRAM的手動傳輸：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">TouchGFXHAL</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">flushFrameBuffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> touchgfx</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Rect</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token class-name" style="color:rgb(255, 203, 107)">HAL</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">flushFrameBuffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">rect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//call superclass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//start transfer if not running already!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token function" style="color:rgb(130, 170, 255)">IsTransmittingData</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">uint8_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> pixels </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Calculate pixel address</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">SendFrameBufferRect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">uint8_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">pixels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">width</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">height</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Queue rect for later or wait here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="highlight highlight-further-reading"><div class="highlight-heading"><h5><div class="highlight-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></div>Further reading</h5></div><div class="highlight-content">透過閱讀使用情境（Scenarios）章節以獲取如何支援各種顯示介面的具體範例。</div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-al-development-introduction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">TouchGFX AL 開發簡介</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/4.16/zh-TW/docs/development/touchgfx-hal-development/touchgfx-generator"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Generator使用者指南</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstraction-layer-classes" class="table-of-contents__link toc-highlight">抽象層物件類別</a></li><li><a href="#synchronize-touchgfx-engine-main-loop-with-display-transfer" class="table-of-contents__link toc-highlight">將「TouchGFX引擎主迴圈」與「顯示傳輸」同步</a><ul><li><a href="#rendering-done" class="table-of-contents__link toc-highlight">渲染算圖完成</a></li><li><a href="#display-ready" class="table-of-contents__link toc-highlight">顯示就緒</a></li></ul></li><li><a href="#report-touch-and-physical-button-events" class="table-of-contents__link toc-highlight">回報銀幕觸摸和實體按鈕事件</a><ul><li><a href="#touch-coordinates" class="table-of-contents__link toc-highlight">銀幕觸控座標</a></li><li><a href="#other-external-events" class="table-of-contents__link toc-highlight">其他的外部事件</a></li></ul></li><li><a href="#synchronize-framebuffer-access" class="table-of-contents__link toc-highlight">影像緩衝存取的同步</a></li><li><a href="#report-the-next-available-framebuffer-area" class="table-of-contents__link toc-highlight">回報下一個可用的影像緩衝區</a></li><li><a href="#perform-render-operations" class="table-of-contents__link toc-highlight">執行渲染算圖</a></li><li><a href="#handle-framebuffer-transfer-to-display" class="table-of-contents__link toc-highlight">從影像緩衝區到顯示器的傳輸處理</a><ul><li><a href="#rendering-of-area-complete" class="table-of-contents__link toc-highlight">區域渲染完畢</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">All rights reserved © 2021 STMicroelectronics | <a href="https://www.st.com/content/st_com/en/common/terms-of-use.html">Terms of use</a> | <a href="https://www.st.com/content/st_com/en/common/privacy-policy.html">Privacy Policy</a> | <a href="/docs/miscellaneous/cookie-policy">Cookie Policy</a> | <a href="https://app-de.onetrust.com/app/#/webform/2b87200d-4023-4588-9df7-ab0cdea1a67e">Exercise your rights</a></div></div></div></footer></div>
<script src="/4.16/zh-TW/assets/js/runtime~main.eee51835.js"></script>
<script src="/4.16/zh-TW/assets/js/main.3ffa3542.js"></script>
</body>
</html>